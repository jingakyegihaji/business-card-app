<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Back Office</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--accent:#2563eb;}
  body{margin:0;font-family:Arial,"맑은 고딕",sans-serif;background:var(--bg);color:var(--text);}
  .wrap{max-width:1320px;margin:18px auto;padding:18px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  h2{margin:0 0 12px}
  h3{margin:0 0 10px;font-size:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button{border:1px solid var(--line);border-radius:10px;padding:10px;font-size:13px;background:#fff}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:12px;line-height:1.4}
  .danger{color:#b91c1c}
  .hidden{display:none}
  .grid{display:grid;grid-template-columns:460px 1fr;gap:14px}
  .gridTpl{display:grid;grid-template-columns:260px 1fr 360px;gap:14px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .fieldRow{display:grid;grid-template-columns:1fr 1fr 110px 70px 38px;gap:8px;align-items:center;margin:8px 0}
  .fieldRow input,.fieldRow select{padding:8px 10px}
  .mini{padding:7px 10px;font-size:12px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#fff}

  .canvasWrap{
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
    overflow:auto;
    max-width:100%;
    max-height:620px;
    padding:10px;
  }
  canvas{
    display:block;
    border:1px solid var(--line);
    border-radius:12px;
    background:#fff;
  }

  .ctrlGrid{
    display:grid;
    grid-template-columns:120px 1fr;
    gap:8px 10px;
    align-items:center;
    margin-top:8px;
  }
  .ctrlGrid label{font-size:12px;color:var(--muted)}
  .ctrlGrid input,.ctrlGrid select{padding:8px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h2>Back Office</h2>

  <div id="loginCard" class="card">
    <h3>관리자 로그인</h3>
    <div class="row">
      <input id="pw" type="password" placeholder="ADMIN_PASSWORD" style="min-width:260px;">
      <button class="primary" onclick="login()">로그인</button>
    </div>
    <div id="loginErr" class="muted danger"></div>
  </div>

  <div id="adminWrap" class="hidden">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <span class="pill">로그인됨</span>
          <div class="muted" style="margin-top:6px">토큰 만료: <span id="exp"></span></div>
        </div>
        <button onclick="logout()">로그아웃</button>
      </div>
    </div>

    <div class="grid">
      <!-- Field Catalog -->
      <div class="card">
        <h3>필드 카탈로그 (전체 후보군)</h3>
        <div class="muted">
          - 여기서 “가능한 입력 항목”을 등록합니다.<br/>
          - 실제 사용자 화면 입력박스는 <b>템플릿별 enabledFields</b>로 결정됩니다.
        </div>
        <div class="hr"></div>
        <div class="row">
          <button class="primary" onclick="addCatalogField()">+ 항목 추가</button>
          <button onclick="saveCatalog()">저장</button>
        </div>
        <div class="hr"></div>
        <div class="muted">Key / Label / Type / Required / (X)</div>
        <div id="catalogBox"></div>
      </div>

      <!-- Template Editor -->
      <div class="card">
        <h3>템플릿별 입력 항목 선택 + 위치/스타일 편집</h3>

        <div class="row">
          <button class="primary" onclick="createTemplate()">+ 템플릿 추가</button>
          <select id="tplSel" onchange="onTplChange()" style="min-width:240px"></select>

          <span class="pill">
            Zoom
            <select id="zoomSel" class="mini" onchange="setZoomFromUI()">
              <option value="1" selected>1x</option>
              <option value="2">2x</option>
              <option value="3">3x</option>
              <option value="4">4x</option>
            </select>
          </span>
          <button class="mini" onclick="centerCanvas()">가운데로</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <input id="tplName" placeholder="템플릿 이름" style="min-width:240px">
          <button class="mini" onclick="saveTemplate()">저장</button>
          <input type="file" id="bgFile" accept="image/*">
          <button class="mini" onclick="uploadBg()">배경 업로드</button>
        </div>

        <div class="hr"></div>

        <div class="gridTpl">
          <!-- enabledFields -->
          <div>
            <div class="muted" style="margin-bottom:8px"><b>이 템플릿에서 사용할 입력 항목</b></div>
            <div id="enabledBox"></div>
            <div class="muted" style="margin-top:10px">
              - 체크된 항목만 사용자 화면 입력 박스로 노출됩니다.
            </div>
          </div>

          <!-- canvas -->
          <div>
            <div class="canvasWrap" id="canvasWrap">
              <canvas id="canvas"></canvas>
            </div>
            <div class="muted" style="margin-top:8px">
              - 저장 좌표는 <b>720×400 기준</b>입니다.
            </div>
          </div>

          <!-- selected style -->
          <div>
            <div class="muted"><b>선택 필드</b></div>
            <div id="selInfo" class="muted">선택 없음</div>

            <div class="hr"></div>

            <div class="muted" style="margin-bottom:6px"><b>폰트/스타일</b></div>
            <div class="ctrlGrid">
              <label>Font</label>
              <select id="stFont">
                <option value='Arial, "맑은 고딕", sans-serif'>Arial/맑은고딕</option>
                <option value='"맑은 고딕", sans-serif'>맑은 고딕</option>
                <option value='"Noto Sans KR", sans-serif'>Noto Sans KR</option>
                <option value='"Pretendard", sans-serif'>Pretendard</option>
                <option value='"Nanum Gothic", sans-serif'>나눔고딕</option>
                <option value='serif'>serif</option>
                <option value='monospace'>monospace</option>
              </select>

              <label>Size</label>
              <input id="stSize" type="number" min="8" max="120" step="1"/>

              <label>Weight</label>
              <select id="stWeight">
                <option value="300">300</option>
                <option value="400">400</option>
                <option value="500">500</option>
                <option value="600">600</option>
                <option value="700">700</option>
                <option value="800">800</option>
              </select>

              <label>Color</label>
              <input id="stColor" type="color"/>

              <label>Opacity</label>
              <input id="stOpacity" type="number" min="0" max="1" step="0.05"/>

              <label>Align</label>
              <select id="stAlign">
                <option value="left">left</option>
                <option value="center">center</option>
                <option value="right">right</option>
              </select>

              <label>Letter Spacing</label>
              <input id="stLs" type="number" step="0.1"/>

              <label>Shadow</label>
              <select id="stShadow">
                <option value="0 2px 10px rgba(0,0,0,0.25)">on</option>
                <option value="none">none</option>
              </select>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="mini" onclick="applyStyleFromUI()">적용</button>
              <button class="mini" onclick="resetSelectedStyle()">선택 필드 기본값</button>
              <button class="mini" onclick="saveTemplate()">템플릿 저장</button>
            </div>

            <div class="muted">
              팁) 템플릿 저장을 눌러야 사용자 화면(F5)에 반영돼요.
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card muted">
      사용자: <b>/</b> &nbsp;|&nbsp; 운영자: <b>/admin.html</b>
    </div>
  </div>
</div>

<script>
  // ===== Token =====
  const LS_TOKEN="admin_token", LS_EXP="admin_expiresAt";
  const loginCard=document.getElementById("loginCard");
  const adminWrap=document.getElementById("adminWrap");
  const expEl=document.getElementById("exp");
  const loginErr=document.getElementById("loginErr");

  function getToken(){return localStorage.getItem(LS_TOKEN)||"";}
  function getExp(){return Number(localStorage.getItem(LS_EXP)||"0");}
  function setToken(t,e){localStorage.setItem(LS_TOKEN,t);localStorage.setItem(LS_EXP,String(e));}
  function clearToken(){localStorage.removeItem(LS_TOKEN);localStorage.removeItem(LS_EXP);}

  function showLogin(msg=""){loginCard.classList.remove("hidden");adminWrap.classList.add("hidden");loginErr.textContent=msg;}
  function showAdmin(){loginCard.classList.add("hidden");adminWrap.classList.remove("hidden");expEl.textContent=new Date(getExp()).toLocaleString();}

  async function adminFetch(url, opt={}){
    const headers = Object.assign({}, opt.headers||{});
    headers["Content-Type"] = headers["Content-Type"] || "application/json";
    headers["Authorization"] = "Bearer " + getToken();
    const res = await fetch(url, { ...opt, headers });
    if (res.status===401){
      clearToken();
      showLogin("인증 만료. 다시 로그인 해주세요.");
      throw new Error("Unauthorized");
    }
    return res;
  }

  async function login(){
    const password = (document.getElementById("pw").value||"").trim();
    if(!password){loginErr.textContent="비밀번호 입력";return;}
    const res = await fetch("/api/admin/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})});
    const json = await res.json().catch(()=>({}));
    if(!res.ok){loginErr.textContent=json?.error||"로그인 실패";return;}
    setToken(json.token,json.expiresAt);
    document.getElementById("pw").value="";
    showAdmin();
    await bootData();
  }
  async function logout(){
    try{await adminFetch("/api/admin/logout",{method:"POST",body:"{}"});}catch(e){}
    clearToken(); showLogin("로그아웃 완료");
  }

  // ===== Data =====
  let catalog = [];
  let templates = [];
  let activeTpl = null;

  // ===== Catalog =====
  const catalogBox = document.getElementById("catalogBox");

  function renderCatalog(){
    catalogBox.innerHTML="";
    catalog.forEach((f, idx)=>{
      const row=document.createElement("div");
      row.className="fieldRow";

      const key=document.createElement("input"); key.placeholder="key"; key.value=f.key||"";
      key.oninput=()=>{ f.key=key.value.trim(); renderEnabledBox(); };

      const label=document.createElement("input"); label.placeholder="label"; label.value=f.label||"";
      label.oninput=()=>{ f.label=label.value; renderEnabledBox(); };

      const type=document.createElement("select");
      ["text","email","tel","number"].forEach(t=>{
        const o=document.createElement("option"); o.value=t; o.textContent=t;
        if((f.type||"text")===t) o.selected=true;
        type.appendChild(o);
      });
      type.onchange=()=>{ f.type=type.value; };

      const req=document.createElement("input"); req.type="checkbox"; req.checked=!!f.required;
      req.onchange=()=>{ f.required=req.checked; };

      const del=document.createElement("button"); del.textContent="X"; del.className="mini";
      del.onclick=()=>{
        const k=f.key;
        catalog.splice(idx,1);
        templates.forEach(t=>{
          if(Array.isArray(t.enabledFields)) t.enabledFields = t.enabledFields.filter(x=>x!==k);
          if(t.fields && k && t.fields[k]) delete t.fields[k];
        });
        renderCatalog();
        renderEnabledBox();
        draw();
      };

      row.appendChild(key);
      row.appendChild(label);
      row.appendChild(type);
      row.appendChild(req);
      row.appendChild(del);
      catalogBox.appendChild(row);
    });
  }

  function addCatalogField(){
    catalog.push({ key:"", label:"", type:"text", required:false, placeholder:"" });
    renderCatalog();
    renderEnabledBox();
  }

  async function saveCatalog(){
    const keys=new Set();
    for(const f of catalog){
      const k=(f.key||"").trim();
      if(!k) return alert("Catalog key는 비울 수 없어요.");
      if(keys.has(k)) return alert("중복 key: " + k);
      keys.add(k);
      f.key=k;
      if(!f.type) f.type="text";
    }
    const res = await adminFetch("/api/admin/fields",{method:"POST",body:JSON.stringify(catalog)});
    const j = await res.json().catch(()=>({}));
    if(!res.ok) return alert("저장 실패: " + (j?.error||res.status));
    await reloadPublicData();
    alert("필드 카탈로그 저장 완료! (사용자 화면 F5 반영)");
  }

  // ===== Templates =====
  const tplSel=document.getElementById("tplSel");
  const tplName=document.getElementById("tplName");

  function renderTplSelect(){
    tplSel.innerHTML="";
    templates.forEach(t=>{
      const o=document.createElement("option");
      o.value=t.id;
      o.textContent=t.name||"(이름 없음)";
      tplSel.appendChild(o);
    });
    if(activeTpl) tplSel.value=activeTpl.id;
  }

  async function createTemplate(){
    const res = await adminFetch("/api/admin/templates",{method:"POST",body:JSON.stringify({name:"New Template"})});
    const tpl = await res.json();
    templates.push(tpl);
    activeTpl=tpl;
    renderTplSelect();
    onTplChange();
  }

  function onTplChange(){
    const id=tplSel.value;
    activeTpl=templates.find(t=>t.id===id)||null;
    tplName.value=activeTpl?.name||"";
    selectedKey=null;
    renderEnabledBox();
    loadBg();
    draw();
    updateSelInfo();
    syncStyleUIFromSelected();
  }

  async function saveTemplate(){
    if(!activeTpl) return alert("템플릿 선택");
    activeTpl.name = tplName.value.trim() || activeTpl.name || "Template";

    const set = new Set(activeTpl.enabledFields || []);
    if(activeTpl.fields){
      for(const k of Object.keys(activeTpl.fields)){
        if(!set.has(k)) delete activeTpl.fields[k];
      }
    }

    const res = await adminFetch(`/api/admin/templates/${activeTpl.id}`,{
      method:"POST",
      body:JSON.stringify({
        name:activeTpl.name,
        backgroundUrl:activeTpl.backgroundUrl||"",
        size:activeTpl.size||{w:720,h:400},
        enabledFields: activeTpl.enabledFields||[],
        fields: activeTpl.fields||{}
      })
    });
    const j=await res.json().catch(()=>({}));
    if(!res.ok) return alert("저장 실패: " + (j?.error||res.status));
    await reloadPublicData();
    alert("템플릿 저장 완료! (사용자 화면 F5 반영)");
  }

  async function uploadBg(){
    if(!activeTpl) return alert("템플릿 선택");
    const f=document.getElementById("bgFile").files?.[0];
    if(!f) return alert("이미지 선택");
    const r=new FileReader();
    r.onload=async()=>{
      const res=await adminFetch(`/api/admin/templates/${activeTpl.id}/upload`,{method:"POST",body:JSON.stringify({dataUrl:r.result})});
      const j=await res.json().catch(()=>({}));
      if(!res.ok) return alert("업로드 실패: " + (j?.error||res.status));
      activeTpl.backgroundUrl=j.url;
      loadBg();
      draw();
      await reloadPublicData();
      alert("배경 업로드 완료!");
    };
    r.readAsDataURL(f);
  }

  // ===== enabledFields =====
  const enabledBox=document.getElementById("enabledBox");

  function defaultFieldStyle(){
    return {
      x: 60,
      y: 80,
      fontSize: 20,
      fontWeight: 600,
      color: "#ffffff",
      opacity: 1,
      align: "left",
      letterSpacing: 0,
      fontFamily: 'Arial, "맑은 고딕", sans-serif',
      textShadow: "0 2px 10px rgba(0,0,0,0.25)"
    };
  }

  function renderEnabledBox(){
    enabledBox.innerHTML="";
    if(!activeTpl) return;

    const enabledSet = new Set(activeTpl.enabledFields || []);
    catalog.forEach(f=>{
      const k=f.key;
      if(!k) return;
      const wrap=document.createElement("div");
      wrap.className="row";
      wrap.style.margin="6px 0";

      const cb=document.createElement("input");
      cb.type="checkbox";
      cb.checked = enabledSet.has(k);
      cb.onchange=()=>{
        activeTpl.enabledFields = activeTpl.enabledFields || [];
        const s=new Set(activeTpl.enabledFields);

        activeTpl.fields = activeTpl.fields || {};
        if(cb.checked){
          s.add(k);
          if(!activeTpl.fields[k]){
            const base = defaultFieldStyle();
            base.y = 70 + Object.keys(activeTpl.fields).length * 32;
            activeTpl.fields[k] = base;
          }
        } else {
          s.delete(k);
          if(activeTpl.fields && activeTpl.fields[k]) delete activeTpl.fields[k];
          if(selectedKey===k) selectedKey=null;
        }

        activeTpl.enabledFields = Array.from(s);
        draw();
        updateSelInfo();
        syncStyleUIFromSelected();
      };

      const text=document.createElement("div");
      text.className="muted";
      text.textContent = `${f.label || k} (${k})`;

      wrap.appendChild(cb);
      wrap.appendChild(text);
      enabledBox.appendChild(wrap);
    });
  }

  // ===== Canvas (logical 720x400 + zoom) =====
  const LOGICAL_W = 720, LOGICAL_H = 400;
  const canvasWrap = document.getElementById("canvasWrap");
  const canvas=document.getElementById("canvas");
  const ctx=canvas.getContext("2d");
  const zoomSel = document.getElementById("zoomSel");
  let zoom = Number(zoomSel.value || "1");

  let bgImg=null;
  let draggingKey=null, offX=0, offY=0;
  let selectedKey=null;
  const selInfo=document.getElementById("selInfo");

  function setZoomFromUI(){ setZoom(Number(zoomSel.value || "1")); }
  function setZoom(z){
    zoom = Math.max(1, Math.min(6, z));
    canvas.width = LOGICAL_W * zoom;
    canvas.height = LOGICAL_H * zoom;
    draw();
    centerCanvas();
  }
  function centerCanvas(){
    const cx = (canvas.width - canvasWrap.clientWidth) / 2;
    const cy = (canvas.height - canvasWrap.clientHeight) / 2;
    canvasWrap.scrollLeft = Math.max(0, cx);
    canvasWrap.scrollTop = Math.max(0, cy);
  }
  function toLogicalCoords(clientX, clientY){
    const r = canvas.getBoundingClientRect();
    const px = (clientX - r.left) * (canvas.width / r.width);
    const py = (clientY - r.top) * (canvas.height / r.height);
    return { x: px / zoom, y: py / zoom };
  }

  function loadBg(){
    bgImg=null;
    if(activeTpl && activeTpl.backgroundUrl){
      const img=new Image();
      img.onload=()=>{bgImg=img; draw();};
      img.src=activeTpl.backgroundUrl;
    } else {
      draw();
    }
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.setTransform(zoom,0,0,zoom,0,0);

    if(activeTpl && activeTpl.backgroundUrl){
      if(!bgImg) loadBg();
      if(bgImg) ctx.drawImage(bgImg, 0, 0, LOGICAL_W, LOGICAL_H);
      else { ctx.fillStyle="#111827"; ctx.fillRect(0,0,LOGICAL_W,LOGICAL_H); }
    } else {
      ctx.fillStyle="#111827";
      ctx.fillRect(0,0,LOGICAL_W,LOGICAL_H);
    }

    if(!activeTpl || !activeTpl.fields) return;
    ctx.font="600 12px Arial";

    for(const [k,s] of Object.entries(activeTpl.fields)){
      const x=Number(s.x||0), y=Number(s.y||0);
      const w=Math.min(300, ctx.measureText(k).width+16);
      const h=22;
      const sel=(k===selectedKey);

      ctx.fillStyle = sel ? "rgba(37,99,235,0.35)" : "rgba(0,0,0,0.35)";
      ctx.fillRect(x,y,w,h);
      ctx.strokeStyle = sel ? "rgba(37,99,235,0.95)" : "rgba(255,255,255,0.35)";
      ctx.strokeRect(x,y,w,h);
      ctx.fillStyle="#fff";
      ctx.fillText(k, x+8, y+15);
    }
  }

  function hit(mx,my){
    if(!activeTpl || !activeTpl.fields) return null;
    ctx.font="600 12px Arial";
    for(const [k,s] of Object.entries(activeTpl.fields)){
      const x=Number(s.x||0), y=Number(s.y||0);
      const w=Math.min(300, ctx.measureText(k).width+16);
      const h=22;
      if(mx>=x && mx<=x+w && my>=y && my<=y+h) return {k,x,y,w,h};
    }
    return null;
  }

  function updateSelInfo(){
    if(!selectedKey) selInfo.textContent="선택 없음";
    else {
      const s = activeTpl?.fields?.[selectedKey];
      selInfo.textContent = `${selectedKey} (x:${s?.x}, y:${s?.y})`;
    }
  }

  canvas.addEventListener("mousedown",(e)=>{
    const p = toLogicalCoords(e.clientX, e.clientY);
    const h=hit(p.x,p.y);
    if(h){
      selectedKey=h.k; draggingKey=h.k;
      offX=p.x-h.x; offY=p.y-h.y;
    } else {
      selectedKey=null; draggingKey=null;
    }
    updateSelInfo();
    syncStyleUIFromSelected();
    draw();
  });

  window.addEventListener("mousemove",(e)=>{
    if(!draggingKey || !activeTpl?.fields?.[draggingKey]) return;
    const p = toLogicalCoords(e.clientX, e.clientY);
    const s=activeTpl.fields[draggingKey];
    s.x=Math.max(0, Math.round(p.x-offX));
    s.y=Math.max(0, Math.round(p.y-offY));
    updateSelInfo();
    draw();
  });
  window.addEventListener("mouseup",()=>{draggingKey=null;});

  // ===== Style UI =====
  const stFont=document.getElementById("stFont");
  const stSize=document.getElementById("stSize");
  const stWeight=document.getElementById("stWeight");
  const stColor=document.getElementById("stColor");
  const stOpacity=document.getElementById("stOpacity");
  const stAlign=document.getElementById("stAlign");
  const stLs=document.getElementById("stLs");
  const stShadow=document.getElementById("stShadow");

  function syncStyleUIFromSelected(){
    if(!selectedKey || !activeTpl?.fields?.[selectedKey]){
      stFont.value = 'Arial, "맑은 고딕", sans-serif';
      stSize.value = 20;
      stWeight.value = 600;
      stColor.value = "#ffffff";
      stOpacity.value = 1;
      stAlign.value = "left";
      stLs.value = 0;
      stShadow.value = "0 2px 10px rgba(0,0,0,0.25)";
      return;
    }
    const s = activeTpl.fields[selectedKey];
    stFont.value = s.fontFamily || 'Arial, "맑은 고딕", sans-serif';
    stSize.value = Number(s.fontSize ?? 20);
    stWeight.value = String(s.fontWeight ?? 600);
    stColor.value = (s.color && s.color.startsWith("#")) ? s.color : "#ffffff";
    stOpacity.value = Number(s.opacity ?? 1);
    stAlign.value = s.align || "left";
    stLs.value = Number(s.letterSpacing ?? 0);
    stShadow.value = s.textShadow || "0 2px 10px rgba(0,0,0,0.25)";
  }

  function applyStyleFromUI(){
    if(!selectedKey || !activeTpl?.fields?.[selectedKey]) return alert("필드를 먼저 선택하세요.");
    const s = activeTpl.fields[selectedKey];

    s.fontFamily = stFont.value;
    s.fontSize = clampNum(Number(stSize.value), 8, 200, 20);
    s.fontWeight = clampNum(Number(stWeight.value), 100, 900, 600);
    s.color = stColor.value || "#ffffff";
    s.opacity = clampNum(Number(stOpacity.value), 0, 1, 1);
    s.align = stAlign.value || "left";
    s.letterSpacing = clampNum(Number(stLs.value), -5, 20, 0);
    s.textShadow = stShadow.value || "none";

    updateSelInfo();
    draw();
  }

  function resetSelectedStyle(){
    if(!selectedKey || !activeTpl?.fields?.[selectedKey]) return alert("필드를 먼저 선택하세요.");
    const keep = activeTpl.fields[selectedKey];
    const base = defaultFieldStyle();
    // 위치는 유지
    base.x = keep.x; base.y = keep.y;
    activeTpl.fields[selectedKey] = base;
    syncStyleUIFromSelected();
    draw();
  }

  function clampNum(v, min, max, fallback){
    if(Number.isNaN(v)) return fallback;
    return Math.max(min, Math.min(max, v));
  }

  // ===== Reload =====
  async function reloadPublicData(){
    catalog = await fetch("/api/fields?_="+Date.now()).then(r=>r.json());
    templates = await fetch("/api/templates?_="+Date.now()).then(r=>r.json());

    renderCatalog();

    if(activeTpl){
      const again = templates.find(t=>t.id===activeTpl.id);
      activeTpl = again || templates[0] || null;
    } else {
      activeTpl = templates[0] || null;
    }

    renderTplSelect();
    if(activeTpl) tplName.value = activeTpl.name || "";
    selectedKey=null;

    renderEnabledBox();
    loadBg();
    updateSelInfo();
    syncStyleUIFromSelected();
    draw();
  }

  async function bootData(){
    setZoom(Number(zoomSel.value || "1"));
    await reloadPublicData();
    centerCanvas();
  }

  (async function boot(){
    const token=getToken(), exp=getExp();
    if(token && exp && exp>Date.now()){
      showAdmin();
      await bootData();
    } else {
      clearToken();
      showLogin();
    }
  })();
</script>
</body>
</html>
