<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Card App (MVP)</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,"맑은 고딕",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:18px auto;padding:18px;}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    h1{font-size:18px;margin:0;letter-spacing:-0.2px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .panel h2{margin:0 0 10px;font-size:14px;}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0;}
    label{font-size:12px;color:var(--muted);width:110px;}
    select,input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;outline:none;background:#fff;font-size:13px;}
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 3px rgba(37,99,235,0.12)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:8px;}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:0.55;cursor:not-allowed;}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.4;}
    .warn{margin-top:10px;font-size:12px;line-height:1.4;padding:10px;border-radius:12px;border:1px dashed #f59e0b;background:#fffbeb;color:#92400e;display:none;}
    code{background:#f3f4f6;border-radius:6px;padding:1px 6px}

    .previewWrap{display:flex;flex-direction:column;gap:12px;}
    .previewHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{font-size:12px;color:var(--muted);}

    #preview{
      width:720px;aspect-ratio:90/50;border-radius:18px;border:1px solid var(--line);
      background:#111827;
      position:relative;overflow:hidden;box-shadow:0 16px 40px rgba(0,0,0,0.16);
      background-size:cover;background-position:center;
    }
    .field{position:absolute;white-space:pre;transform-origin:left top;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.25);user-select:none;}
    .cornerMark{
      position:absolute;inset:0;pointer-events:none;opacity:0.16;
      background:
        linear-gradient(#fff,#fff) left 16px top 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) left 16px top 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) right 16px top 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) right 16px top 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) left 16px bottom 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) left 16px bottom 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) right 16px bottom 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) right 16px bottom 16px / 2px 24px no-repeat;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      #preview{width:100%}
      label{width:95px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>명함 주문 MVP</h1>
        <p class="sub">Back office 데이터(/api/templates, /api/fields) 기반으로 동작</p>
      </div>
      <div class="badge">User: / &nbsp; Admin: /admin.html</div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>설정</h2>

        <div class="row">
          <label for="templateSel">템플릿</label>
          <select id="templateSel"></select>
        </div>

        <!-- ✅ fields.json 기반으로 폼 자동 생성 -->
        <div id="dynamicFields"></div>

        <div class="btns">
          <button class="primary" id="btnSend">전송하기</button>
          <button id="btnReload">템플릿 새로고침</button>
        </div>

        <div class="hint">
          - 템플릿/필드 정의는 서버에서 가져옵니다: <code>/api/templates</code>, <code>/api/fields</code><br/>
          - Back office에서 템플릿 추가 후, 여기서 <b>F5</b> 또는 “템플릿 새로고침”을 누르면 반영됩니다.
        </div>

        <div class="warn" id="warnBox"></div>
      </section>

      <section class="previewWrap">
        <div class="previewHeader">
          <div class="badge">Preview (#preview)</div>
          <div class="badge">90×50mm (720×400)</div>
        </div>

        <div id="preview">
          <div class="cornerMark" aria-hidden="true"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== EmailJS init =====
    emailjs.init("r-E6Bb0BR6UOFLDbb"); // Public Key

    const SERVICE_ID = "service_6qyisv8";
    const TEMPLATE_ID = "template_1bls7qs";

    // ===== DOM =====
    const elTemplateSel = document.getElementById("templateSel");
    const elPreview = document.getElementById("preview");
    const elDynamicFields = document.getElementById("dynamicFields");
    const warnBox = document.getElementById("warnBox");

    const btnSend = document.getElementById("btnSend");
    const btnReload = document.getElementById("btnReload");

    // ===== State =====
    let templates = [];
    let fieldDefs = [];
    let inputs = {}; // key -> input element

    function showWarn(msg){
      warnBox.style.display = "block";
      warnBox.textContent = msg;
    }
    function clearWarn(){
      warnBox.style.display = "none";
      warnBox.textContent = "";
    }

    function cacheBusted(url){
      const u = new URL(url, window.location.origin);
      u.searchParams.set("_", Date.now().toString());
      return u.toString();
    }

    async function loadFields(){
      const res = await fetch(cacheBusted("/api/fields"));
      if (!res.ok) throw new Error("fields load failed: " + res.status);
      fieldDefs = await res.json();
    }

    async function loadTemplates(){
      const res = await fetch(cacheBusted("/api/templates"));
      if (!res.ok) throw new Error("templates load failed: " + res.status);
      templates = await res.json();
    }

    function populateTemplates(){
      elTemplateSel.innerHTML = "";

      if (!templates.length){
        elTemplateSel.innerHTML = `<option value="">(템플릿 없음)</option>`;
        elTemplateSel.value = "";
        showWarn("템플릿이 없습니다. /admin.html에서 템플릿을 추가하고 배경 이미지를 업로드한 뒤 다시 시도하세요.");
        return;
      }

      clearWarn();
      elTemplateSel.innerHTML = templates.map(t => `<option value="${t.id}">${escapeHtml(t.name || "(이름 없음)")}</option>`).join("");
      elTemplateSel.value = templates[0].id;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function getActiveTemplate(){
      const id = elTemplateSel.value;
      return templates.find(t => t.id === id) || null;
    }

    function buildForm(){
      elDynamicFields.innerHTML = "";
      inputs = {};

      fieldDefs
        .slice()
        .forEach(def => {
          const row = document.createElement("div");
          row.className = "row";

          const lab = document.createElement("label");
          lab.textContent = def.label || def.key;
          lab.setAttribute("for", "inp_" + def.key);

          const inp = document.createElement("input");
          inp.id = "inp_" + def.key;
          inp.placeholder = def.label || def.key;
          inp.value = sampleValue(def.key);
          inp.addEventListener("input", renderPreview);

          row.appendChild(lab);
          row.appendChild(inp);
          elDynamicFields.appendChild(row);

          inputs[def.key] = inp;
        });
    }

    function sampleValue(key){
      const samples = {
        name: "홍길동",
        title: "Sales Manager",
        company: "ACME Inc.",
        phone: "+82 10-1234-5678",
        email: "hello@example.com"
      };
      return samples[key] || "";
    }

    function applyTemplateBackground(tpl){
      // 배경 이미지가 있으면 그걸 우선 사용
      if (tpl && tpl.backgroundUrl){
        elPreview.style.backgroundImage = `url('${tpl.backgroundUrl}')`;
        elPreview.style.backgroundColor = "#111827";
      } else {
        elPreview.style.backgroundImage = "none";
        elPreview.style.backgroundColor = "#111827";
      }
    }

    function renderPreview(){
      const tpl = getActiveTemplate();
      applyTemplateBackground(tpl);

      // 기존 field 제거
      elPreview.querySelectorAll(".field").forEach(n => n.remove());

      if (!tpl) return;

      const values = {};
      Object.keys(inputs).forEach(k => values[k] = (inputs[k].value || ""));

      const fieldMap = tpl.fields || {};
      Object.entries(fieldMap).forEach(([key, spec]) => {
        const div = document.createElement("div");
        div.className = "field";
        div.textContent = values[key] ?? "";

        div.style.left = Math.round(spec.x ?? 0) + "px";
        div.style.top  = Math.round(spec.y ?? 0) + "px";
        div.style.fontSize = Math.round(spec.fontSize ?? 18) + "px";
        div.style.fontWeight = (spec.fontWeight ?? 400);
        div.style.opacity = (spec.opacity ?? 1);
        div.style.letterSpacing = (spec.letterSpacing ?? 0) + "px";
        div.style.textAlign = spec.align || "left";
        if (spec.color) div.style.color = spec.color;
        if (spec.textShadow) div.style.textShadow = spec.textShadow;

        elPreview.appendChild(div);
      });
    }

    async function makePreviewJpegDataUrl(maxWidth = 720, quality = 0.55) {
      const canvas = await html2canvas(document.querySelector("#preview"), {
        scale: 1,
        useCORS: true,
        backgroundColor: null
      });

      const w = canvas.width;
      const h = canvas.height;
      const ratio = Math.min(1, maxWidth / w);

      const out = document.createElement("canvas");
      out.width = Math.round(w * ratio);
      out.height = Math.round(h * ratio);

      const ctx = out.getContext("2d");
      ctx.drawImage(canvas, 0, 0, out.width, out.height);

      return out.toDataURL("image/jpeg", quality);
    }

    async function uploadPreviewToServer(dataUrl) {
      const res = await fetch("/api/upload-preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dataUrl })
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok) throw new Error(json?.error || ("Upload failed: " + res.status));
      return new URL(json.url, window.location.origin).toString();
    }

    btnSend.addEventListener("click", async () => {
      btnSend.disabled = true;
      try {
        const tpl = getActiveTemplate();
        if (!tpl) throw new Error("템플릿이 없습니다.");

        const previewDataUrl = await makePreviewJpegDataUrl(720, 0.55);
        const previewUrl = await uploadPreviewToServer(previewDataUrl);

        // payload는 기존 변수명 유지 + preview_url 추가
        const payload = {
          template_name: tpl.name || "",
          preview_url: previewUrl
        };
        Object.keys(inputs).forEach(k => payload["customer_" + k] = (inputs[k].value || "").trim());

        await emailjs.send(SERVICE_ID, TEMPLATE_ID, payload);
        alert("전송 완료! 미리보기 URL 포함해서 보냈어요.");
      } catch (e) {
        console.error(e);
        alert("전송 실패: " + (e?.message || String(e)));
      } finally {
        btnSend.disabled = false;
      }
    });

    btnReload.addEventListener("click", async () => {
      try{
        await boot();
        alert("템플릿 새로고침 완료!");
      }catch(e){
        alert("새로고침 실패: " + (e?.message || String(e)));
      }
    });

    // 템플릿 변경 시 미리보기 다시 렌더
    elTemplateSel.addEventListener("change", renderPreview);

    async function boot(){
      clearWarn();
      await loadFields();
      await loadTemplates();
      populateTemplates();
      buildForm();
      renderPreview();
    }

    boot().catch(e => {
      console.error(e);
      showWarn("초기 로딩 실패: " + (e?.message || String(e)));
    });
  </script>
</body>
</html>
