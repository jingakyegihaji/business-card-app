<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>명함 주문 MVP</title>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,"맑은 고딕",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:18px auto;padding:18px;}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    h1{font-size:18px;margin:0;letter-spacing:-0.2px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .panel h2{margin:0 0 10px;font-size:14px;}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0;}
    label{font-size:12px;color:var(--muted);width:110px;}
    select,input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;outline:none;background:#fff;font-size:13px;}
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 3px rgba(37,99,235,0.12)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:13px;display:inline-flex;align-items:center;gap:8px;}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:0.55;cursor:not-allowed;}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45;}
    .toast{
      display:none;margin-top:10px;padding:10px 12px;border-radius:12px;
      border:1px dashed #c7d2fe;background:#eef2ff;color:#1f2937;font-size:12px;line-height:1.4;
      white-space:pre-wrap;
    }

    .previewWrap{display:flex;flex-direction:column;gap:12px;}
    .previewHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{font-size:12px;color:var(--muted);}

    #preview{
      width:720px;aspect-ratio:90/50;border-radius:18px;border:1px solid var(--line);
      background:linear-gradient(135deg,#0b1220,#111827);
      position:relative;overflow:hidden;box-shadow:0 16px 40px rgba(0,0,0,0.16);
    }
    #preview::before{
      content:"";position:absolute;inset:-40px;
      background:
        radial-gradient(circle at 20% 30%, rgba(37,99,235,0.55), transparent 45%),
        radial-gradient(circle at 70% 60%, rgba(16,185,129,0.38), transparent 46%),
        radial-gradient(circle at 40% 80%, rgba(249,115,22,0.28), transparent 50%);
      filter:blur(2px);opacity:0.9;pointer-events:none;
    }
    .field{position:absolute;white-space:pre;transform-origin:left top;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.25);user-select:none;}
    .cornerMark{
      position:absolute;inset:0;pointer-events:none;opacity:0.16;
      background:
        linear-gradient(#fff,#fff) left 16px top 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) left 16px top 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) right 16px top 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) right 16px top 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) left 16px bottom 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) left 16px bottom 16px / 2px 24px no-repeat,
        linear-gradient(#fff,#fff) right 16px bottom 16px / 24px 2px no-repeat,
        linear-gradient(#fff,#fff) right 16px bottom 16px / 2px 24px no-repeat;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      #preview{width:100%}
      label{width:95px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>명함 주문 MVP</h1>
        <p class="sub">템플릿 → 좌표 배치 → 입력 즉시 반영 → 전송하기(메일 + 미리보기 URL)</p>
      </div>
      <div class="badge">EmailJS + html2canvas + Render Upload</div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>설정</h2>

        <div class="row">
          <label for="templateSel">템플릿</label>
          <select id="templateSel"></select>
        </div>

        <div class="row">
          <label for="nameInput">이름</label>
          <input id="nameInput" value="홍길동"/>
        </div>

        <div class="row">
          <label for="titleInput">직함</label>
          <input id="titleInput" value="Sales Manager"/>
        </div>

        <div class="row">
          <label for="companyInput">회사</label>
          <input id="companyInput" value="ACME Inc."/>
        </div>

        <div class="row">
          <label for="phoneInput">전화</label>
          <input id="phoneInput" value="+82 10-1234-5678"/>
        </div>

        <div class="row">
          <label for="emailInput">이메일</label>
          <input id="emailInput" value="hello@example.com"/>
        </div>

        <div class="btns">
          <button class="primary" id="btnSend">전송하기</button>
        </div>

        <div class="hint">
          - 전송 시 미리보기를 캡쳐하여 서버(<code>/uploads</code>)에 저장하고, 공개 URL을 EmailJS로 전송합니다.<br/>
          - EmailJS 템플릿에서 <b>{{preview_url}}</b> 변수를 사용해 이미지를 표시하세요.<br/>
          - Render는 재배포/재시작 시 업로드가 날아갈 수 있습니다(확인용 MVP면 OK).
        </div>

        <div id="debug" class="toast"></div>
      </section>

      <section class="previewWrap">
        <div class="previewHeader">
          <div class="badge">Preview (#preview)</div>
          <div class="badge">90×50mm</div>
        </div>

        <div id="preview">
          <div class="cornerMark" aria-hidden="true"></div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ====== 디버그 박스 ======
    const debugEl = document.getElementById("debug");
    function debug(msg){
      debugEl.style.display = "block";
      debugEl.textContent = String(msg);
    }
    window.addEventListener("error", (e) => {
      debug("[JS Error] " + (e?.message || e));
    });

    // ====== EmailJS init ======
    try{
      emailjs.init("r-E6Bb0BR6UOFLDbb"); // Public Key
    }catch(e){
      debug("EmailJS init 실패: " + (e?.message || e));
    }

    // ====== 템플릿 ======
    const templates = [
      {
        id: "classic_dark",
        name: "Classic Dark",
        style: { lightBg: false },
        fields: {
          company:{ x: 50,  y: 76,  fontSize: 26, fontWeight: 600, opacity: 0.95, align:"left" },
          name:   { x: 48,  y: 150, fontSize: 44, fontWeight: 700, letterSpacing: 0.2, align:"left" },
          title:  { x: 50,  y: 208, fontSize: 22, fontWeight: 400, opacity: 0.9, align:"left" },
          phone:  { x: 50,  y: 300, fontSize: 20, fontWeight: 400, opacity: 0.9, align:"left" },
          email:  { x: 50,  y: 330,
