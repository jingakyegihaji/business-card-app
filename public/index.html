<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>명함 주문 MVP</title>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--accent:#2563eb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,"맑은 고딕",sans-serif;background:var(--bg);color:var(--text);}
    .wrap{max-width:1200px;margin:18px auto;padding:18px;}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    h1{font-size:18px;margin:0;letter-spacing:-0.2px;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
    .panel h2{margin:0 0 10px;font-size:14px;}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0;}
    label{font-size:12px;color:var(--muted);width:110px;}
    select,input{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;outline:none;background:#fff;font-size:13px;}
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 3px rgba(37,99,235,0.12)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    button{border:1px solid var(--line);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:13px;}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
    button:disabled{opacity:0.55;cursor:not-allowed;}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.4;}
    .warn{margin-top:10px;font-size:12px;line-height:1.4;padding:10px;border-radius:12px;border:1px dashed #f59e0b;background:#fffbeb;color:#92400e;display:none;}

    .previewWrap{display:flex;flex-direction:column;gap:12px;}
    .previewHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .badge{font-size:12px;color:var(--muted);}

    #preview{
      width:720px;height:400px;border-radius:18px;border:1px solid var(--line);
      background:#111827;
      position:relative;overflow:hidden;box-shadow:0 16px 40px rgba(0,0,0,0.16);
      background-size:cover;background-position:center;
    }
    .field{position:absolute;white-space:pre;transform-origin:left top;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,0.25);user-select:none;}
    .cornerMark{position:absolute;inset:0;pointer-events:none;opacity:0.16}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      #preview{width:100%;height:auto;aspect-ratio:90/50}
      label{width:95px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>명함 주문 MVP</h1>
        <p class="sub">템플릿별로 입력 항목이 달라집니다.</p>
      </div>
      <div class="badge">Admin: /admin.html</div>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>설정</h2>

        <div class="row">
          <label for="templateSel">템플릿</label>
          <select id="templateSel"></select>
        </div>

        <div id="dynamicFields"></div>

        <div class="btns">
          <button class="primary" id="btnSend">전송하기</button>
          <button id="btnReload">새로고침</button>
        </div>

        <div class="hint">
          - 입력폼은 선택 템플릿의 <b>enabledFields</b> 기준으로 생성됩니다.<br/>
          - 위치는 템플릿의 <b>fields[key].x/y</b> 기준입니다.
        </div>

        <div class="warn" id="warnBox"></div>
      </section>

      <section class="previewWrap">
        <div class="previewHeader">
          <div class="badge">Preview</div>
          <div class="badge">720×400</div>
        </div>

        <div id="preview"></div>
      </section>
    </div>
  </div>

<script>
  emailjs.init("r-E6Bb0BR6UOFLDbb");
  const SERVICE_ID = "service_6qyisv8";
  const TEMPLATE_ID = "template_1bls7qs";

  const elTemplateSel = document.getElementById("templateSel");
  const elDynamicFields = document.getElementById("dynamicFields");
  const elPreview = document.getElementById("preview");
  const warnBox = document.getElementById("warnBox");
  const btnSend = document.getElementById("btnSend");
  const btnReload = document.getElementById("btnReload");

  let catalog = [];
  let templates = [];
  let inputs = {};

  function showWarn(msg){ warnBox.style.display="block"; warnBox.textContent=msg; }
  function clearWarn(){ warnBox.style.display="none"; warnBox.textContent=""; }
  function cacheBusted(url){ const u=new URL(url, location.origin); u.searchParams.set("_", Date.now()); return u.toString(); }

  async function loadAll(){
    catalog = await fetch(cacheBusted("/api/fields")).then(r=>r.json());
    templates = await fetch(cacheBusted("/api/templates")).then(r=>r.json());
  }

  function populateTemplates(){
    elTemplateSel.innerHTML="";
    if(!templates.length){
      elTemplateSel.innerHTML = `<option value="">(템플릿 없음)</option>`;
      showWarn("템플릿이 없습니다. 운영자에게 템플릿 추가를 요청하세요.");
      return;
    }
    clearWarn();
    elTemplateSel.innerHTML = templates.map(t=>`<option value="${t.id}">${escapeHtml(t.name||"(이름 없음)")}</option>`).join("");
    elTemplateSel.value = templates[0].id;
  }

  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  function getTpl(){
    return templates.find(t=>t.id===elTemplateSel.value) || null;
  }

  function buildFormForTemplate(tpl){
    elDynamicFields.innerHTML="";
    inputs = {};

    if(!tpl) return;

    const enabled = Array.isArray(tpl.enabledFields) ? tpl.enabledFields : [];
    if(!enabled.length){
      showWarn("이 템플릿에는 입력 항목이 선택되어 있지 않아요. 운영자가 enabledFields를 체크해야 합니다.");
    } else {
      clearWarn();
    }

    const byKey = new Map((catalog||[]).map(f=>[f.key, f]));
    enabled.forEach(key=>{
      const def = byKey.get(key) || { key, label:key, type:"text", required:false, placeholder:"" };

      const row = document.createElement("div");
      row.className="row";

      const lab = document.createElement("label");
      lab.textContent = def.label || def.key;

      const inp = document.createElement("input");
      inp.type = def.type || "text";
      inp.placeholder = def.placeholder || "";
      inp.required = !!def.required;
      inp.value = sample(def.key);

      inp.addEventListener("input", renderPreview);

      row.appendChild(lab);
      row.appendChild(inp);
      elDynamicFields.appendChild(row);

      inputs[key] = inp;
    });
  }

  function sample(key){
    const s = {
      name:"홍길동", title:"Sales Manager", company:"ACME Inc.",
      mobile:"+82 10-1234-5678", office_phone:"02-123-4567", fax:"02-777-7777",
      email:"hello@example.com", address:"서울시 ..."
    };
    return s[key] || "";
  }

  function renderPreview(){
    const tpl = getTpl();
    if(!tpl){
      elPreview.style.backgroundImage="none";
      elPreview.style.backgroundColor="#111827";
      return;
    }

    elPreview.style.width = (tpl.size?.w || 720) + "px";
    elPreview.style.height = (tpl.size?.h || 400) + "px";
    elPreview.style.borderRadius = "18px";
    elPreview.style.border = "1px solid #e5e7eb";
    elPreview.style.position = "relative";
    elPreview.style.overflow = "hidden";
    elPreview.style.boxShadow = "0 16px 40px rgba(0,0,0,0.16)";
    elPreview.style.backgroundSize="cover";
    elPreview.style.backgroundPosition="center";
    if(tpl.backgroundUrl){
      elPreview.style.backgroundImage = `url('${tpl.backgroundUrl}')`;
      elPreview.style.backgroundColor="#111827";
    } else {
      elPreview.style.backgroundImage="none";
      elPreview.style.backgroundColor="#111827";
    }

    elPreview.querySelectorAll(".field").forEach(n=>n.remove());

    const values = {};
    Object.keys(inputs).forEach(k => values[k] = inputs[k].value || "");

    const fieldMap = tpl.fields || {};
    Object.entries(fieldMap).forEach(([key, spec])=>{
      const div=document.createElement("div");
      div.className="field";
      div.textContent = values[key] ?? "";

      div.style.left = Math.round(spec.x ?? 0) + "px";
      div.style.top  = Math.round(spec.y ?? 0) + "px";
      div.style.fontSize = Math.round(spec.fontSize ?? 18) + "px";
      div.style.fontWeight = (spec.fontWeight ?? 400);
      div.style.opacity = (spec.opacity ?? 1);
      div.style.textAlign = spec.align || "left";
      div.style.position="absolute";
      div.style.whiteSpace="pre";
      div.style.transformOrigin="left top";
      div.style.userSelect="none";
      div.style.color = spec.color || "#ffffff";
      div.style.textShadow = spec.textShadow || "0 2px 10px rgba(0,0,0,0.25)";

      elPreview.appendChild(div);
    });
  }

  async function makePreviewJpegDataUrl(maxWidth=720, quality=0.55){
    const canvas = await html2canvas(document.querySelector("#preview"), {
      scale: 1, useCORS: true, backgroundColor: null
    });
    const w=canvas.width, h=canvas.height;
    const ratio=Math.min(1, maxWidth/w);
    const out=document.createElement("canvas");
    out.width=Math.round(w*ratio);
    out.height=Math.round(h*ratio);
    out.getContext("2d").drawImage(canvas,0,0,out.width,out.height);
    return out.toDataURL("image/jpeg", quality);
  }

  async function uploadPreviewToServer(dataUrl){
    const res = await fetch("/api/upload-preview",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ dataUrl })
    });
    const json = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(json?.error || ("Upload failed: "+res.status));
    return new URL(json.url, window.location.origin).toString();
  }

  btnSend.addEventListener("click", async ()=>{
    btnSend.disabled=true;
    try{
      const tpl=getTpl();
      if(!tpl) throw new Error("템플릿 없음");
      const previewDataUrl = await makePreviewJpegDataUrl(720, 0.55);
      const previewUrl = await uploadPreviewToServer(previewDataUrl);

      const payload = {
        template_name: tpl.name || "",
        preview_url: previewUrl
      };
      Object.keys(inputs).forEach(k => payload["customer_"+k] = (inputs[k].value||"").trim());

      await emailjs.send(SERVICE_ID, TEMPLATE_ID, payload);
      alert("전송 완료!");
    } catch(e){
      console.error(e);
      alert("전송 실패: " + (e?.message || String(e)));
    } finally {
      btnSend.disabled=false;
    }
  });

  btnReload.addEventListener("click", boot);
  elTemplateSel.addEventListener("change", ()=>{
    const tpl=getTpl();
    buildFormForTemplate(tpl);
    renderPreview();
  });

  async function boot(){
    await loadAll();
    populateTemplates();
    const tpl=getTpl();
    buildFormForTemplate(tpl);
    renderPreview();
  }

  boot().catch(e=>{
    console.error(e);
    showWarn("로딩 실패: " + (e?.message || String(e)));
  });
</script>
</body>
</html>
