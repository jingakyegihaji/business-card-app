<script>
  const templates = [ /* ... 너 기존 templates 그대로 ... */ ];

  const elTemplateSel = document.getElementById("templateSel");
  const elPreview = document.getElementById("preview");

  const inputs = {
    name: document.getElementById("nameInput"),
    title: document.getElementById("titleInput"),
    company: document.getElementById("companyInput"),
    phone: document.getElementById("phoneInput"),
    email: document.getElementById("emailInput"),
  };

  function populateTemplates() {
    elTemplateSel.innerHTML = templates.map(t => `<option value="${t.id}">${t.name}</option>`).join("");
    elTemplateSel.value = templates[0].id;
  }
  function getActiveTemplate() {
    return templates.find(t => t.id === elTemplateSel.value) || templates[0];
  }
  function applyTemplateStyle(tpl) {
    if (tpl.style && tpl.style.lightBg) {
      elPreview.style.background = "linear-gradient(135deg, #ffffff, #f3f4f6)";
      elPreview.style.boxShadow = "0 16px 40px rgba(0,0,0,0.10)";
    } else {
      elPreview.style.background = "linear-gradient(135deg, #0b1220, #111827)";
      elPreview.style.boxShadow = "0 16px 40px rgba(0,0,0,0.16)";
    }
  }
  function renderPreview() {
    const tpl = getActiveTemplate();
    applyTemplateStyle(tpl);

    elPreview.querySelectorAll(".field").forEach(n => n.remove());

    const values = {
      name: inputs.name.value || "",
      title: inputs.title.value || "",
      company: inputs.company.value || "",
      phone: inputs.phone.value || "",
      email: inputs.email.value || ""
    };

    Object.entries(tpl.fields).forEach(([key, spec]) => {
      const div = document.createElement("div");
      div.className = "field";
      div.textContent = values[key] ?? "";
      div.style.left = Math.round(spec.x ?? 0) + "px";
      div.style.top  = Math.round(spec.y ?? 0) + "px";
      div.style.fontSize = Math.round(spec.fontSize ?? 18) + "px";
      div.style.fontWeight = (spec.fontWeight ?? 400);
      div.style.opacity = (spec.opacity ?? 1);
      div.style.letterSpacing = (spec.letterSpacing ?? 0) + "px";
      div.style.textAlign = spec.align || "left";
      if (spec.color) div.style.color = spec.color;
      if (spec.textShadow) div.style.textShadow = spec.textShadow;
      elPreview.appendChild(div);
    });
  }

  // ✅ 미리보기 캡쳐 → 용량 줄인 JPG dataURL 만들기
  async function makePreviewJpegDataUrl(maxWidth = 720, quality = 0.55) {
    const canvas = await html2canvas(document.querySelector("#preview"), {
      scale: 1,
      useCORS: true,
      backgroundColor: null
    });

    const w = canvas.width;
    const h = canvas.height;
    const ratio = Math.min(1, maxWidth / w);

    const out = document.createElement("canvas");
    out.width = Math.round(w * ratio);
    out.height = Math.round(h * ratio);

    const ctx = out.getContext("2d");
    ctx.drawImage(canvas, 0, 0, out.width, out.height);

    return out.toDataURL("image/jpeg", quality);
  }

  // ✅ 전송
  const btnSend = document.getElementById("btnSend");
  btnSend.addEventListener("click", async () => {
    btnSend.disabled = true;

    try {
      // 1) 캡쳐 생성 (여기서 await 사용!)
      const previewDataUrl = await makePreviewJpegDataUrl(720, 0.55);

      // 2) EmailJS로 보낼 payload 구성
      //    - 템플릿 Attachments 탭에서 Variable Attachment 만들고
      //      Parameter Name을 "card_image"로 해두면,
      //      이 값이 첨부 + cid 임베드에 쓰임
      const payload = {
        customer_name: inputs.name.value.trim(),
        customer_title: inputs.title.value.trim(),
        customer_company: inputs.company.value.trim(),
        customer_phone: inputs.phone.value.trim(),
        customer_email: inputs.email.value.trim(),
        template_name: getActiveTemplate().name,

        // ⭐️ 핵심: attachment 변수(이름이 Parameter Name과 동일해야 함)
        card_image: previewDataUrl
      };

      const SERVICE_ID = "service_6qyisv8";
      const TEMPLATE_ID = "template_1bls7qs";

      await emailjs.send(SERVICE_ID, TEMPLATE_ID, payload);
      alert("전송 완료! ahsvic@naver.com 으로 메일을 보냈어요.");
    } catch (e) {
      console.error(e);
      alert("전송 실패: " + (e?.text || e?.message || String(e)));
    } finally {
      btnSend.disabled = false;
    }
  });

  // 초기화
  populateTemplates();
  renderPreview();
  elTemplateSel.addEventListener("change", renderPreview);
  Object.values(inputs).forEach(inp => inp.addEventListener("input", renderPreview));
</script>
